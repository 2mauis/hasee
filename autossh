u8 m_Dir[5];
u8 m_Init_Flag[5];   // ³õÊ¼Î»ÖÃ±êÖ¾
void Positon_Init_Check()
{
	if(m_GPIO_Mode!=OUTPP)
	 GPIO_Reconfig(OUTPP); //
	
     if((m_Positon_Init_Flag&M1)==UNINT)	//  ¼ì²âµç»úÎ»ÖÃÊÇ·ñ³õÊ¼»¯Íê³É.
	 {
	 switch(GPIOD->IDR&0x03)
		{
			case ON_MIN:   // ÔÚÁãÎ»ÖÃ   
			{
		       if(m_Dir[MOTOR1]==MOTOR_DIR_BACKWARD)//ÊÇ·ñ´æÔÚ·½Ïò
			    {     
						if(m_Init_Flag[MOTOR1]==ON_MAX) //Èç¹û³õÊ¼Î»ÖÃÎª ×î´óµã
						{
						m_Relative_Step_Max[MOTOR1]=m_Step_Count[MOTOR1]/2+1;
						m_Status_Relative_Step[MOTOR1]=0;
						m_Step_Count[MOTOR1]=0;	
						Motor_Free(MOTOR1);  //Ê§ÄÜµç»ú
						SETB(m_Positon_Init_Flag,0); // ÉèÖÃ ³õÊ¼»¯Íê³É±êÖ¾	
						}
// 						if(m_Init_Flag[MOTOR1]==ON_MID)//Èç¹û³õÊ¼Î»ÖÃ·Ç Áãµã »ò¼«´óµã|||||||  Èç¹ûÔÚÖÐ¼äÒ»ÂÉÉèÖÃ ³õÊ¼·½Ïò ÏòÇ°  Ôò ²»´æÔÚ ´ÎÖÖÇé¿ö
// 						{
// 						m_Step_Count[MOTOR1]=0;		
// 						Motor1_Direction_Control(m_Dir[MOTOR1]=MOTOR_DIR_FORWARD);//  ÉèÖÃµ±Ç°·½ÏòÏòÇ° ºÍÊ¹ÄÜµç»ú·½ÏòÏòÇ°
// 						}	
                 }
				
				else 
				{   m_Step_Count[MOTOR1]=0;	
					m_Init_Flag[MOTOR1]=ON_MIN;//³õÊ¼Î»ÖÃÔÚÁãµã
					Motor1_Direction_Control(m_Dir[MOTOR1]=MOTOR_DIR_FORWARD);//  ÉèÖÃµ±Ç°·½Ïò ºÍÊ¹ÄÜµç»ú·½Ïò
				}
				 
		    }break;
			
			case ON_MAX: 
			{
				if(m_Dir[MOTOR1]==MOTOR_DIR_FORWARD)  //¼ì²âµç»ú ÊÇ·ñ´æÔÚµ±Ç°·½Ïò
				{
					if(m_Init_Flag[MOTOR1]==ON_MIN)
					{
						m_Relative_Step_Max[MOTOR1]=m_Status_Relative_Step[MOTOR1]=m_Step_Count[MOTOR1]/2+1;
						m_Step_Count[MOTOR1]=0;	
						Motor_Free(MOTOR1);  //Ê§ÄÜµç»ú
						SETB(m_Positon_Init_Flag,0); // ÉèÖÃ ³õÊ¼»¯Íê³É±êÖ¾		
					}
					
					if(m_Init_Flag[MOTOR1]==ON_MID)//Èç¹û³õÊ¼Î»ÖÃ·Ç Áãµã »ò¼«´óµã
						{
						m_Init_Flag[MOTOR1]=ON_MAX;  //ÖØÉè³õÊ¼»¯Î»ÖÃÎª  ¼«´óÖµµã	
						m_Step_Count[MOTOR1]=0;		
						Motor1_Direction_Control(m_Dir[MOTOR1]=MOTOR_DIR_BACKWARD);//  ÉèÖÃµ±Ç°·½ÏòÏòÇ° ºÍÊ¹ÄÜµç»ú·½ÏòÏòÇ°
						}	
					
				}
			  else
			  { 
				  m_Step_Count[MOTOR1]=0;	
				  m_Init_Flag[MOTOR1]=ON_MAX;    // ³õÊ¼Î»ÖÃÔÚ¼«µã
				  Motor1_Direction_Control(m_Dir[MOTOR1]=MOTOR_DIR_FORWARD);
			  }
				
			}break;
			
			default : //Ä¬ÈÏ×´Ì¬ 3 ,³õÊ¼Î»ÖÃ·Ç Áãµã »ò¼«´óµã
			{
					if(m_Dir[MOTOR1]==MOTOR_DIR_STOP)
					{
					m_Init_Flag[MOTOR1]=ON_MID;    // ³õÊ¼Î»ÖÃÔÚÖÐ¼ä  
					m_Step_Count[MOTOR1]=0;
					 Motor1_Direction_Control(m_Dir[MOTOR1]=MOTOR_DIR_FORWARD);  //Ò»ÂÉÉèÖÃ³öÊ¼·½ÏòÎªÏòÇ°.
					}
					
			}break;
        } 
    
			m_Step_Count[MOTOR1]++;
		    GPIOA->ODR^=0x1 ; // ·´×ªpaµÄµçÆ½.
	}




}


















void  GPIO_Reconfig(u8  GPIO_Mode)
{
// 	GPIO_InitTypeDef GPIO_InitStructure;
// 	
// 	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  if(GPIO_Mode==AFPP)	
	{
	//GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;
	
	GPIOA->CRL&=0xF0FFFF00;		
	GPIOA->CRL|=0xFDFFFFDD; // ÉèÖÃpa 0, 1, 6 ÎªAF_pp Ä£Ê½
	
	GPIOA->CRH&=0xFFFFFFF0;	
	GPIOA->CRH|=0x0000000D;// ÉèÖÃpa08 Îªafpp
	
	GPIOB->CRH&=0xFFFFFFF0;
	GPIOB->CRH&=0x0000000D;//ÉèÖÃpB08 Îªafpp
		
	m_GPIO_Mode=AFPP;//±ê¼Çµ±Ç°µ±Ç°µç»ústep  Òý½ÅÎªafpp
	}
 else
	{ 
		//GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
	GPIOA->CRL&=0xF0FFFF00;		
	GPIOA->CRL|=0xF3FFF33; // ÉèÖÃpa 0 ,1 ,6 Îªout_pp Ä£Ê½
		
	GPIOA->CRL&=0xFFFFFFF0;	
	GPIOA->CRH|=0x00000003;// ÉèÖÃpa08 ÎªÍÆÍìÄ£Ê½
		
	GPIOB->CRH&=0xFFFFFFF0;	
	GPIOB->CRH|=0x00000003;// ÉèÖÃpb08 Î» ÍÆÍìÄ£Ê½	
		
    m_GPIO_Mode=OUTPP;//±ê¼Çµ±Ç°µ±Ç°µç»ústep  Òý½ÅÎªoutpp
	GPIOA->ODR&=~0x143;  //À­µÍÒý½ÅµçÆ½
	GPIOB->BRR&=~0x100;//À­µÍÒý½ÅµçÆ½
		
	}
	
// 	GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_0|GPIO_Pin_1|GPIO_Pin_6|GPIO_Pin_8;
// 	GPIO_Init(GPIOA, &GPIO_InitStructure);
// 	
// 	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8;
// 	GPIO_Init(GPIOB, &GPIO_InitStructure);
	
// 	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6;
// 	GPIO_Init(GPIOC, &GPIO_InitStructure); µç»ú6   ²»ÐèÒª ÖØ¶¨Òå
	
}
